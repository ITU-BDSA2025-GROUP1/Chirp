@page "/"
@using Chirp.Core.DTOs
@using System.Security.Claims
@model Chirp.Web.Pages.PublicModel
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
}
@{
    var idString = User.FindFirstValue(ClaimTypes.NameIdentifier);
    int.TryParse(idString, out var userId);
}

<div>
    <h2> Public Timeline </h2>
    @if (User?.Identity?.IsAuthenticated == true)
    {
        <form method="post" id="cheep-form" data-testid="cheep-form">
            <div>
                <label for="cheep-text">New Cheep (max 160 chars)</label><br />
                <textarea name="text" id="cheep-text" data-testid="cheep-input" rows="3" style="width:100%" data-max="160"></textarea>
                <div class="text-muted" style="font-size:0.8rem" id="cheep-hint" data-testid="cheep-hint">160 characters left</div>
            </div>
            <button type="submit" id="cheep-submit" data-testid="cheep-submit">Share</button>
            @if (!ViewContext.ViewData.ModelState.IsValid)
            {
                <div class="validation-summary-errors" data-testid="cheep-error">
                    @foreach (var error in ViewContext.ViewData.ModelState.SelectMany(kvp => kvp.Value!.Errors))
                    {
                        <div>@error.ErrorMessage</div>
                    }
                </div>
            }
        </form>
        <script>
            (function(){
                const ta = document.getElementById('cheep-text');
                const hint = document.getElementById('cheep-hint');
                if(!ta || !hint) return;
                ta.addEventListener('input', function(){
                    const left = 160 - ta.value.length;
                    hint.textContent = left + ' characters left';
                    hint.style.color = left < 0 ? 'red' : '#666';
                });
            })();
        </script>
    }
    else
    {
        <p data-testid="login-reminder">Log in to post a cheep.</p>
    }

    @if (Model.Cheeps.Any())
    {
        <ul id="messagelist" class="cheeps">
            @foreach (var cheep in Model.Cheeps)
            {
                <li> 
                    <p>
                        <strong>
                            <a href="/@cheep.Author">@cheep.Author</a>
                        </strong>
                        
                        @if (User.Identity?.IsAuthenticated == true && cheep.AuthorId != userId)
                        {
                            @if (Model.IsFollowing(Model.CurrentAuthorName, cheep.Author))
                            {
                                <form method="post" asp-page-handler="Unfollow" 
                                    
                                    style="display:inline;">
                                    <input type="hidden" name="authorName" value="@cheep.Author" />
                                    <button type="submit">Unfollow</button>
                                </form>
                            }
                            else
                            {
                                <form method="post" asp-page-handler="Follow" 
                                    
                                    style="display:inline;">
                                    <input type="hidden" name="authorName" value="@cheep.Author" />
                                    <button type="submit">Follow</button>
                                </form>
                            }
                        }
                    </p>
 <p>
    @if (User.Identity?.IsAuthenticated == true)
    {
        <form method="post" asp-page-handler="Like">
            <input type="hidden" name="cheepId" value="@cheep.CheepId" />
            <button type="submit" class="like-btn">
                @if (cheep.LikedByCurrentUser)
                {
                    <span>❤️ @cheep.LikeCount</span>
                }
                else
                {
                    <span>🤍 @cheep.LikeCount</span>
                }
            </button>
        </form>
    }
    else
    {
        <!-- Not logged in: show likes only -->
        <span>❤️ @cheep.LikeCount</span>
    }
</p>

                    <p>
                        @cheep.Message
                        <small>&mdash; @cheep.Timestamp</small>
                    </p>
                </li>
            }
        </ul>
        
        <div class="pagination">
            @if (Model.CurrentPage > 1)
            {
                <a href="/?page=@(Model.CurrentPage - 1)">« Previous</a>
            }
            <span>Page @Model.CurrentPage</span>
            <a href="/?page=@(Model.CurrentPage + 1)">Next »</a>
        </div>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }

    <script>
  (function () {
    // Restore scroll after reload
    const y = sessionStorage.getItem("scrollY");
    if (y !== null) {
      window.scrollTo(0, parseInt(y, 10));
      sessionStorage.removeItem("scrollY");
    }

    // Save scroll before any postback form submit
    document.addEventListener("submit", function (e) {
      const form = e.target;
      if (form && form.method && form.method.toLowerCase() === "post") {
        sessionStorage.setItem("scrollY", String(window.scrollY));
      }
    }, true);
  })();
</script>
</div>
